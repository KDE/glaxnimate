.pypi_build:
    stage: build
    tags:
        - Linux
    only:
        - master
        - release
        - tags
        - pypi
    script:
        - python3 --version
        - python -m venv .venv
        - source .venv/bin/activate
        - apt-get update
        - apt-get install -y cmake
        - mkdir build
        - cd build
        - cmake ..
        - make glaxnimate_python_depends_install
        - make glaxnimate_python
    artifacts:
        paths:
            - build/bin/python/build/lib/

#linux:pypi_3.8:
    #extends: .pypi_build
    #image: python:3.8

#linux:pypi_3.9:
    #extends: .pypi_build
    #image: python:3.8

linux:pypi_3.10:
    extends: .pypi_build
    image: python:3.10

linux:pypi_3.11:
    extends: .pypi_build
    image: python:3.11

linux:pypi_3.12:
    extends: .pypi_build
    image: python:3.12


linux:pypi_deploy_gitlab:
    image: python:3.10
    stage: deploy
    needs:
        - linux:pypi_3.10
    dependencies:
        - linux:pypi_3.10
    script:
        - python3 --version
        - apt-get install -y cmake
        - mkdir -p build
        - cd build
        - cmake .. -DVERSION_SUFFIX="git.`date +%Y%m%d%H%M%S`.$CI_COMMIT_BRANCH.$CI_COMMIT_SHORT_SHA"
        - make glaxnimate_python_depends_install
        - ls bin/python/build/lib
        - make glaxnimate_python_wheel
        - python3 -m twine upload bin/python/dist/*.whl --repository-url $CI_API_V4_URL/projects/$CI_PROJECT_ID/packages/pypi --verbose
    only:
        - master
        - release
    environment:
        name: Gitlab PyPI

linux:pypi_deploy_tag_pypy-org:
    image: python:3.10
    stage: deploy
    needs:
        - linux:pypi_3.10
    dependencies:
        - linux:pypi_3.10
    script:
        - python3 --version
        - apt-get install -y cmake
        - mkdir -p build
        - cd build
        - if [ -z "$CI_COMMIT_TAG" ] ; then version="$(../deploy/pypi_version_tail.sh)"; else version=""; fi
        - cmake .. -DVERSION_SUFFIX="$version"
        - make glaxnimate_python_depends_install
        - ls bin/python/build/lib
        - make glaxnimate_python_wheel
        - make glaxnimate_python_upload
    environment:
        name: PyPI
    only:
        - tags
        - pypi
